# Azure Pipeline for PTO Track

trigger:
  branches:
    include:
      - main

variables:
  serverName: 'YOUR_SERVER_NAME'
  deployFolder: 'c:\inet\pto.track'
  forwardedHttpUrl: 'http://localhost:5139'
  forwardedHttpsUrl: 'https://localhost:7241'
  rewritePath: 'c:\inet\pto.track\web.config'

pool:
  name: Default

stages:
  - stage: Build
    displayName: 'Build Solution'
    jobs:
      - job: Build
        steps:
          - powershell: |
              $sdk = dotnet --list-sdks
              if ($sdk -notmatch '9.0') {
                  Write-Error 'Required .NET SDK 9.0 is not installed.'
                  exit 1
              }
            displayName: 'Check .NET SDK Version'
            failOnStderr: true
          - powershell: |
              dotnet tool list -g | Select-String 'dotnet-ef'
              if ($LASTEXITCODE -ne 0) {
                  Write-Error 'dotnet-ef tool is not installed globally.'
                  exit 1
              }
            displayName: 'Check dotnet-ef Tool'
            failOnStderr: true
          - script: dotnet restore
            displayName: 'Restore NuGet Packages'
          - script: dotnet build pto.track/pto.track.csproj --configuration Release
            displayName: 'Build Project'

  - stage: Test
    displayName: 'Run Tests and Coverage'
    dependsOn: Build
    jobs:
      - job: Test
        steps:
          - script: dotnet test **/*.tests.csproj --configuration Release --collect:"XPlat Code Coverage"
            displayName: 'Run .NET Tests with Coverage (All Projects)'
          - script: pwsh ./pto.track.tests.js/run-headless.ps1
            displayName: 'Run QUnit JavaScript Tests'
          - task: PublishTestResults@2
            inputs:
              testResultsFiles: '**/TestResults/*.trx'
              testRunTitle: 'C# Test Results'
          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.cobertura.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/**/TestResults/'
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(System.DefaultWorkingDirectory)/pto.track.tests.js/save-results.html'
              artifactName: 'JavaScriptTestReport'

  - stage: Publish
    displayName: 'Publish Standalone App'
    dependsOn: Test
    jobs:
      - job: Publish
        steps:
          - script: dotnet publish pto.track/pto.track.csproj -c Release -o $(deployFolder) --self-contained -r win-x64
            displayName: 'Publish Standalone Application'

  - stage: Deploy
    displayName: 'Deploy to IIS Server'
    dependsOn: Publish
    jobs:
      - job: Deploy
        steps:
          - powershell: |
              # Check for IIS installation
              $iisFeature = Get-WindowsFeature -Name Web-Server
              if (-not $iisFeature.Installed) {
                  Write-Error "IIS (Web-Server) is not installed. Deployment cannot continue."
                  exit 1
              }
            displayName: 'Check IIS Installation'
            failOnStderr: true
          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(deployFolder)'
              Contents: '**'
              TargetFolder: '\\$(serverName)\$(deployFolder)'
          - powershell: |
              # Update IIS rewrite rules
              $webConfig = "$(rewritePath)"
              [xml]$config = Get-Content $webConfig
              $rules = $config.configuration.'system.webServer'.rewrite.rules
              # Remove existing rules (optional)
              $rules.Clear()
              # Add HTTP rule
              $httpRule = $rules.CreateElement('rule')
              $httpRule.SetAttribute('name', 'Forward HTTP')
              $httpRule.SetAttribute('stopProcessing', 'true')
              $httpAction = $httpRule.CreateElement('action')
              $httpAction.SetAttribute('type', 'Rewrite')
              $httpAction.SetAttribute('url', '$(forwardedHttpUrl)')
              $httpRule.AppendChild($httpAction)
              $rules.AppendChild($httpRule)
              # Add HTTPS rule
              $httpsRule = $rules.CreateElement('rule')
              $httpsRule.SetAttribute('name', 'Forward HTTPS')
              $httpsRule.SetAttribute('stopProcessing', 'true')
              $httpsAction = $httpsRule.CreateElement('action')
              $httpsAction.SetAttribute('type', 'Rewrite')
              $httpsAction.SetAttribute('url', '$(forwardedHttpsUrl)')
              $httpsRule.AppendChild($httpsAction)
              $rules.AppendChild($httpsRule)
              $config.Save($webConfig)
            displayName: 'Update IIS Rewrite Rules'
            failOnStderr: true
