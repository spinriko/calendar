@page
@model pto.track.Pages.AbsencesModel
@{
    ViewData["Title"] = "Absence Requests";
}

<script src="~/lib/daypilot/daypilot-all.min.js" asp-append-version="true"></script>

<div class="main">
    <div class="left">
        <div id="datepicker"></div>
    </div>
    <div class="right">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 15px;">
            <div class="buttons">
                <button id="previous">Previous</button>
                <button id="today">Today</button>
                <button id="next">Next</button>
            </div>
            <div id="statusFilters"
                style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f5f5f5; border-radius: 4px;">
                <span style="font-weight: 600; margin-right: 5px;">Show:</span>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterPending" value="Pending" checked
                        style="width: 16px; height: 16px; accent-color: #ffa500;">
                    <span>Pending</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterApproved" value="Approved" checked
                        style="width: 16px; height: 16px; accent-color: #6aa84f;">
                    <span>Approved</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterRejected" value="Rejected" checked
                        style="width: 16px; height: 16px; accent-color: #cc4125;">
                    <span>Rejected</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterCancelled" value="Cancelled" checked
                        style="width: 16px; height: 16px; accent-color: #999999;">
                    <span>Cancelled</span>
                </label>
            </div>
            <div id="impersonationPanel"
                style="display: none; background: #fff3cd; padding: 8px 12px; border-radius: 4px; border: 2px solid #ffc107;">
                <label style="margin-right: 10px; font-weight: 600; color: #856404;">ðŸŽ­ Impersonate:</label>
                <select id="impersonateRole"
                    style="padding: 5px 10px; border: 1px solid #ffc107; border-radius: 4px; background: white; cursor: pointer; font-size: 14px;">
                    <option value="Admin">Admin (All Roles)</option>
                    <option value="Manager">Manager</option>
                    <option value="Approver">Approver</option>
                    <option value="Employee">Employee</option>
                </select>
            </div>
        </div>
        <div id="calendar"></div>
    </div>
</div>

<script>
    const calendar = new DayPilot.Calendar("calendar", {
        viewType: "Resources",
        durationBarVisible: false,
        eventMoveHandling: "Disabled",
        eventResizeHandling: "Disabled",
        cellWidthMin: 50, // Minimum column width to keep readable
        scrollDelayEvents: 0,
        scrollX: "Enabled", // Enable horizontal scrolling
        onTimeRangeSelected: async (args) => {
            const form = [
                { name: "Reason", id: "reason", type: "textarea" },
            ];

            const modal = await DayPilot.Modal.form(form);
            calendar.clearSelection();
            if (modal.canceled) {
                return;
            }

            const absence = {
                start: args.start,
                end: args.end,
                employeeId: args.resource,
                reason: modal.result.reason
            };

            const { data } = await DayPilot.Http.post(`/api/absences`, absence);

            calendar.events.add({
                start: data.start,
                end: data.end,
                id: data.id,
                text: data.reason,
                resource: data.employeeId,
                barColor: getStatusColor(data.status),
                data: data
            });

        },
        onEventClick: async (args) => {
            const absence = args.e.data.data || args.e.data;

            const form = [
                { name: "Employee", id: "employeeName", disabled: true },
                { name: "Reason", id: "reason", type: "textarea" },
                { name: "Status", id: "status", disabled: true },
                { name: "Requested", id: "requestedDate", type: "date", disabled: true },
            ];

            if (absence.approverName) {
                form.push({ name: "Approver", id: "approverName", disabled: true });
                form.push({ name: "Approved Date", id: "approvedDate", type: "date", disabled: true });
            }

            if (absence.approvalComments) {
                form.push({ name: "Comments", id: "approvalComments", type: "textarea", disabled: true });
            }

            // Prepare data for the form with proper field values
            // Format dates to remove excess precision that DayPilot can't parse
            const formData = {
                employeeName: absence.employeeName,
                reason: absence.reason,
                status: absence.status,
                requestedDate: absence.requestedDate ? absence.requestedDate.split('T')[0] : null,
                approverName: absence.approverName,
                approvedDate: absence.approvedDate ? absence.approvedDate.split('T')[0] : null,
                approvalComments: absence.approvalComments
            };

            const modal = await DayPilot.Modal.form(form, formData);
            if (modal.canceled) {
                return;
            }

            // For now, only show details. Update functionality would need status checking
            if (absence.status === "Pending") {
                const updateData = {
                    start: absence.start,
                    end: absence.end,
                    reason: modal.result.reason
                };

                await DayPilot.Http.put(`/api/absences/${absence.id}`, updateData);

                calendar.events.update({
                    ...args.e.data,
                    reason: modal.result.reason,
                    text: modal.result.reason
                });
            }
        },
        onBeforeEventRender: args => {
            const status = args.data.status || args.data.data?.status;
            args.data.backColor = getStatusColor(status);
            args.data.borderColor = "darker";
            args.data.fontColor = "#ffffff";

            args.data.areas = [];

            // Add approve/reject buttons for pending requests
            if (status === "Pending") {
                args.data.areas.push({
                    right: 35,
                    top: 5,
                    width: 22,
                    height: 22,
                    symbol: "icons/daypilot.svg#checkmark",
                    cssClass: "area_action",
                    padding: 2,
                    toolTip: "Approve",
                    onClick: async args => {
                        const e = args.source;
                        const modal = await DayPilot.Modal.prompt("Approve this absence request? (Optional comment):");
                        if (modal.canceled) {
                            return true;
                        }

                        const approvalData = {
                            approverId: app.state.currentEmployeeId,
                            comments: modal.result
                        };

                        await DayPilot.Http.post(`/api/absences/${e.id()}/approve`, approvalData);
                        app.loadCalendarData();
                        console.log("Approved.");
                    }
                });

                args.data.areas.push({
                    right: 5,
                    top: 5,
                    width: 22,
                    height: 22,
                    symbol: "icons/daypilot.svg#x-2",
                    cssClass: "area_action",
                    padding: 2,
                    toolTip: "Reject",
                    onClick: async args => {
                        const e = args.source;
                        const modal = await DayPilot.Modal.prompt("Rejection reason:");
                        if (modal.canceled || !modal.result) {
                            return true;
                        }

                        const rejectionData = {
                            approverId: app.state.currentEmployeeId,
                            reason: modal.result
                        };

                        await DayPilot.Http.post(`/api/absences/${e.id()}/reject`, rejectionData);
                        app.loadCalendarData();
                        console.log("Rejected.");
                    }
                });
            }

            // Add delete button for all statuses
            if (status === "Pending" || status === "Cancelled") {
                args.data.areas.push({
                    right: 5,
                    bottom: 5,
                    width: 22,
                    height: 22,
                    symbol: "icons/daypilot.svg#x-circle",
                    cssClass: "area_action",
                    padding: 2,
                    toolTip: "Delete",
                    onClick: async args => {
                        const e = args.source;
                        const modal = await DayPilot.Modal.confirm("Delete this absence request?");
                        if (modal.canceled) {
                            return true;
                        }
                        await DayPilot.Http.delete(`/api/absences/${e.id()}`);
                        calendar.events.remove(e);
                        console.log("Deleted.");
                    }
                });
            }
        },
        onBeforeHeaderRender: args => {
            args.header.verticalAlignment = "top";
        },
        headerHeight: 60,
    });
    calendar.init();

    const datepicker = new DayPilot.Navigator("datepicker", {
        selectMode: "Day",
        showMonths: 3,
        skipMonths: 3,
        onTimeRangeSelected: args => {
            calendar.update({
                startDate: args.start,
            });
            app.loadCalendarData();
        },
        onVisibleRangeChanged: args => {
            app.loadDatePickerData();
        }
    });
    datepicker.init();

    function getStatusColor(status) {
        switch (status) {
            case "Pending": return "#ffa500cc";
            case "Approved": return "#6aa84fcc";
            case "Rejected": return "#cc4125cc";
            case "Cancelled": return "#999999cc";
            default: return "#2e78d6cc";
        }
    }

    const app = {
        elements: {
            previous: document.getElementById("previous"),
            today: document.getElementById("today"),
            next: document.getElementById("next"),
            filterPending: document.getElementById("filterPending"),
            filterApproved: document.getElementById("filterApproved"),
            filterRejected: document.getElementById("filterRejected"),
            filterCancelled: document.getElementById("filterCancelled"),
            impersonationPanel: document.getElementById("impersonationPanel"),
            impersonateRole: document.getElementById("impersonateRole")
        },
        state: {
            selectedStatuses: ["Pending", "Approved"],
            currentEmployeeId: null,
            isManager: false,
            currentUser: null,
            isMockMode: false
        },
        async init() {
            // Load current user information
            await this.loadCurrentUser();

            // Initialize checkboxes based on role
            this.initializeCheckboxes();

            this.loadCalendarData();
            this.loadDatePickerData();
            this.initEventHandlers();
        },
        initializeCheckboxes() {
            // Determine which checkboxes should be available based on role
            const isAdmin = this.state.currentUser?.roles?.includes("Admin");
            const isManagerOrApprover = this.state.isManager;
            const isEmployee = !isAdmin && !isManagerOrApprover;

            // Hide/show checkboxes based on role
            if (isEmployee) {
                // Employees can only see their own requests in all states
                this.elements.filterPending.checked = true;
                this.elements.filterApproved.checked = false;
                this.elements.filterRejected.checked = false;
                this.elements.filterCancelled.checked = false;
                this.state.selectedStatuses = ["Pending"];
            } else if (isManagerOrApprover && !isAdmin) {
                // Managers/Approvers mainly care about Pending (to approve) and Approved (to verify)
                this.elements.filterPending.checked = true;
                this.elements.filterApproved.checked = true;
                this.elements.filterRejected.checked = false;
                this.elements.filterCancelled.checked = false;
                this.elements.filterRejected.parentElement.style.display = "none";
                this.elements.filterCancelled.parentElement.style.display = "none";
                this.state.selectedStatuses = ["Pending", "Approved"];
            } else if (isAdmin) {
                // Admins see everything by default
                this.elements.filterPending.checked = true;
                this.elements.filterApproved.checked = true;
                this.elements.filterRejected.checked = true;
                this.elements.filterCancelled.checked = true;
                this.state.selectedStatuses = ["Pending", "Approved", "Rejected", "Cancelled"];
            }
        },
        async loadCurrentUser() {
            try {
                const response = await DayPilot.Http.get("/api/currentuser");
                if (response.data) {
                    this.state.currentUser = response.data;
                    this.state.currentEmployeeId = response.data.id;
                    this.state.isMockMode = response.data.isMockMode || false;
                    this.state.isManager = response.data.isApprover ||
                        response.data.roles?.some(r =>
                            r.toLowerCase() === 'manager' ||
                            r.toLowerCase() === 'approver'
                        );

                    // Show impersonation panel in mock mode
                    if (this.state.isMockMode) {
                        this.elements.impersonationPanel.style.display = "block";
                        // Set current role in dropdown
                        const currentRole = response.data.roles?.includes("Admin") ? "Admin" :
                            response.data.roles?.includes("Manager") ? "Manager" :
                                response.data.roles?.includes("Approver") ? "Approver" : "Employee";
                        this.elements.impersonateRole.value = currentRole;
                    }

                    console.log("Current user:", this.state.currentUser);
                    console.log("Is manager/approver:", this.state.isManager);
                    console.log("Mock mode:", this.state.isMockMode);
                }
            } catch (error) {
                console.warn("Could not load current user, using defaults:", error);
                // Fallback for development without authentication
                this.state.currentEmployeeId = 1;
            }
        },
        async loadCalendarData() {
            const start = calendar.visibleStart();
            const end = calendar.visibleEnd();

            let absencesUrl = `/api/absences?start=${start}&end=${end}`;

            // Add all selected statuses to the query
            this.state.selectedStatuses.forEach(status => {
                absencesUrl += `&status=${status}`;
            });

            // For employees, only show their own requests
            if (!this.state.isManager && !this.state.currentUser?.roles?.includes("Admin")) {
                absencesUrl += `&employeeId=${this.state.currentEmployeeId}`;
            }

            const promiseAbsences = DayPilot.Http.get(absencesUrl);
            const promiseResources = DayPilot.Http.get("/api/resources");

            const [{ data: columns }, { data: absences }] = await Promise.all([promiseResources, promiseAbsences]);

            // Map absences to calendar events
            const events = absences.map(a => ({
                id: a.id,
                start: a.start,
                end: a.end,
                text: a.reason,
                resource: a.employeeId,
                barColor: getStatusColor(a.status),
                data: a
            }));

            calendar.update({
                columns,
                events
            });
        },
        async loadDatePickerData() {
            const start = datepicker.visibleStart();
            const end = datepicker.visibleEnd();

            let absencesUrl = `/api/absences?start=${start}&end=${end}`;

            // Add all selected statuses to the query
            this.state.selectedStatuses.forEach(status => {
                absencesUrl += `&status=${status}`;
            });

            // For employees, only show their own requests
            if (!this.state.isManager && !this.state.currentUser?.roles?.includes("Admin")) {
                absencesUrl += `&employeeId=${this.state.currentEmployeeId}`;
            }

            const { data } = await DayPilot.Http.get(absencesUrl);

            const events = data.map(a => ({
                start: a.start,
                end: a.end,
                text: a.reason,
                barColor: getStatusColor(a.status)
            }));

            datepicker.update({ events });
        },
        addHandlers() {
            app.elements.previous.addEventListener("click", () => {
                const current = datepicker.selectionDay;
                datepicker.select(current.addDays(-1));
            });
            app.elements.next.addEventListener("click", () => {
                const current = datepicker.selectionDay;
                datepicker.select(current.addDays(1));
            });
            app.elements.today.addEventListener("click", () => {
                datepicker.select(DayPilot.Date.today());
            });

            // Checkbox filter handlers
            const updateFilters = () => {
                app.state.selectedStatuses = [];
                if (app.elements.filterPending.checked) app.state.selectedStatuses.push("Pending");
                if (app.elements.filterApproved.checked) app.state.selectedStatuses.push("Approved");
                if (app.elements.filterRejected.checked) app.state.selectedStatuses.push("Rejected");
                if (app.elements.filterCancelled.checked) app.state.selectedStatuses.push("Cancelled");

                app.loadCalendarData();
                app.loadDatePickerData();
            };

            app.elements.filterPending.addEventListener("change", updateFilters);
            app.elements.filterApproved.addEventListener("change", updateFilters);
            app.elements.filterRejected.addEventListener("change", updateFilters);
            app.elements.filterCancelled.addEventListener("change", updateFilters);

            // Impersonation handler
            if (app.elements.impersonateRole) {
                app.elements.impersonateRole.addEventListener("change", async (e) => {
                    const role = e.target.value;
                    try {
                        await DayPilot.Http.post("/api/currentuser/impersonate", { role });
                        console.log(`Impersonating ${role}, reloading user...`);

                        // Reload current user and refresh data
                        await app.loadCurrentUser();
                        
                        // Reinitialize checkboxes for new role
                        app.initializeCheckboxes();
                        
                        app.loadCalendarData();
                        app.loadDatePickerData();

                        // Show notification
                        const notification = await DayPilot.Modal.alert(`Now impersonating: ${role}`);
                    } catch (error) {
                        console.error("Error setting impersonation:", error);
                        await DayPilot.Modal.alert("Failed to change impersonation");
                    }
                });
            }
        },
        initEventHandlers() {
            this.addHandlers();
        }
    };

    app.init();

</script>