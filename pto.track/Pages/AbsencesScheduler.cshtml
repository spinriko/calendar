@page
@model pto.track.Pages.AbsencesSchedulerModel
@{
    ViewData["Title"] = "Absence Scheduler View";
}

<script src="~/lib/daypilot/daypilot-all.min.js" asp-append-version="true"></script>

<div class="main">
    <div class="left">
        <div id="datepicker"></div>
    </div>
    <div class="right">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 15px;">
            <div class="buttons">
                <button id="previous">Previous</button>
                <button id="today">Today</button>
                <button id="next">Next</button>
            </div>
            <div id="statusFilters"
                style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f5f5f5; border-radius: 4px;">
                <span style="font-weight: 600; margin-right: 5px;">Show:</span>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterPending" value="Pending" checked
                        style="width: 16px; height: 16px; accent-color: #ffa500;">
                    <span>Pending</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterApproved" value="Approved" checked
                        style="width: 16px; height: 16px; accent-color: #6aa84f;">
                    <span>Approved</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterRejected" value="Rejected" checked
                        style="width: 16px; height: 16px; accent-color: #cc4125;">
                    <span>Rejected</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="filterCancelled" value="Cancelled" checked
                        style="width: 16px; height: 16px; accent-color: #999999;">
                    <span>Cancelled</span>
                </label>
            </div>
        </div>
        <div id="scheduler"></div>
    </div>
</div>

<script src="~/js/calendar-functions.js"></script>
<script>
    const scheduler = new DayPilot.Scheduler("scheduler", {
        startDate: DayPilot.Date.today().addDays(-7),
        days: 21,
        scale: "Hour",
        cellDuration: 30,
        timeHeaders: [
            { groupBy: "Month" },
            { groupBy: "Day", format: "ddd M/d" },
            { groupBy: "Hour", format: "h tt" }
        ],
        cellWidth: 40,
        eventHeight: 30,
        businessBeginsHour: 8,
        businessEndsHour: 18,
        showNonBusiness: false, // Hide non-business hours
        businessWeekends: false, // Also hide weekends
        onIncludeTimeCell: (args) => {
            // Only include cells within business hours (8 AM - 6 PM)
            const hour = args.cell.start.getHours();
            args.cell.enabled = hour >= 8 && hour < 18;
        },
        rowHeaderColumns: [
            { text: "Employee", display: "name" }
        ],
        eventMoveHandling: "Disabled",
        eventResizeHandling: "Disabled",
        treeEnabled: true,
        onTimeRangeSelected: async (args) => {
            // Check if employee can create absence for this resource
            const isAdmin = app.state.currentUser?.roles?.includes("Admin") || false;
            const isManager = app.state.isManager || false;
            const isApprover = app.state.currentUser?.isApprover || false;

            if (!canCreateAbsenceForResource(app.state.currentEmployeeId, args.resource, isManager, isAdmin, isApprover)) {
                scheduler.clearSelection();
                await DayPilot.Modal.alert("You can only create absence requests for yourself. Please select your own row in the scheduler.");
                return;
            }

            const form = [
                { name: "Reason", id: "reason", type: "textarea" },
            ];

            const modal = await DayPilot.Modal.form(form);
            scheduler.clearSelection();
            if (modal.canceled) {
                return;
            }

            const absence = {
                start: args.start.toString(),
                end: args.end.toString(),
                employeeId: parseInt(args.resource, 10),
                reason: modal.result.reason
            };

            console.log("Sending absence request:", absence);

            try {
                const { data } = await DayPilot.Http.post(`/api/absences`, absence);

                scheduler.events.add({
                    start: data.start,
                    end: data.end,
                    id: data.id,
                    text: data.reason,
                    resource: data.employeeId,
                    barColor: getStatusColor(data.status),
                    data: data
                });
            } catch (error) {
                console.error("Error creating absence:", error);
                const errorMsg = error.request?.responseText || error.message || "Unknown error";
                console.error("Error details:", errorMsg);
                await DayPilot.Modal.alert(`Failed to create absence: ${errorMsg}`);
            }

        },
        onEventClick: async (args) => {
            const absence = args.e.data.data || args.e.data;

            const form = [
                { name: "Employee", id: "employeeName", disabled: true },
                { name: "Reason", id: "reason", type: "textarea" },
                { name: "Status", id: "status", disabled: true },
                { name: "Requested", id: "requestedDate", type: "date", disabled: true },
            ];

            if (absence.approverName) {
                form.push({ name: "Approver", id: "approverName", disabled: true });
                form.push({ name: "Approved Date", id: "approvedDate", type: "date", disabled: true });
            }

            if (absence.approvalComments) {
                form.push({ name: "Comments", id: "approvalComments", type: "textarea", disabled: true });
            }

            // Prepare data for the form with proper field values
            // Format dates to remove excess precision that DayPilot can't parse
            const formData = {
                employeeName: absence.employeeName,
                reason: absence.reason,
                status: absence.status,
                requestedDate: absence.requestedDate ? absence.requestedDate.split('T')[0] : null,
                approverName: absence.approverName,
                approvedDate: absence.approvedDate ? absence.approvedDate.split('T')[0] : null,
                approvalComments: absence.approvalComments
            };

            const modal = await DayPilot.Modal.form(form, formData);
            if (modal.canceled) {
                return;
            }

            // For now, only show details. Update functionality would need status checking
            if (absence.status === "Pending") {
                const updateData = {
                    start: absence.start,
                    end: absence.end,
                    reason: modal.result.reason
                };

                await DayPilot.Http.put(`/api/absences/${absence.id}`, updateData);

                scheduler.events.update({
                    ...args.e.data,
                    reason: modal.result.reason,
                    text: modal.result.reason
                });
            }
        },
        onBeforeEventRender: args => {
            const status = args.data.status || args.data.data?.status;
            args.data.backColor = getStatusColor(status);
            args.data.borderColor = "darker";
            args.data.fontColor = "#ffffff";

            args.data.areas = [];

            // Add approve/reject buttons for pending requests
            if (status === "Pending") {
                args.data.areas.push({
                    right: 35,
                    top: 5,
                    width: 22,
                    height: 22,
                    symbol: "icons/daypilot.svg#checkmark",
                    cssClass: "area_action",
                    padding: 2,
                    toolTip: "Approve",
                    onClick: async args => {
                        const e = args.source;
                        const modal = await DayPilot.Modal.prompt("Approve this absence request? (Optional comment):");
                        if (modal.canceled) {
                            return true;
                        }

                        const approvalData = {
                            approverId: app.state.currentEmployeeId,
                            comments: modal.result
                        };

                        await DayPilot.Http.post(`/api/absences/${e.id()}/approve`, approvalData);
                        app.loadSchedulerData();
                        console.log("Approved.");
                    }
                });

                args.data.areas.push({
                    right: 5,
                    top: 5,
                    width: 22,
                    height: 22,
                    symbol: "icons/daypilot.svg#x-2",
                    cssClass: "area_action",
                    padding: 2,
                    toolTip: "Reject",
                    onClick: async args => {
                        const e = args.source;
                        const modal = await DayPilot.Modal.prompt("Rejection reason:");
                        if (modal.canceled || !modal.result) {
                            return true;
                        }

                        const rejectionData = {
                            approverId: app.state.currentEmployeeId,
                            reason: modal.result
                        };

                        await DayPilot.Http.post(`/api/absences/${e.id()}/reject`, rejectionData);
                        app.loadSchedulerData();
                        console.log("Rejected.");
                    }
                });
            }

            // Add delete button for all statuses
            if (status === "Pending" || status === "Cancelled") {
                args.data.areas.push({
                    right: 5,
                    bottom: 5,
                    width: 22,
                    height: 22,
                    symbol: "icons/daypilot.svg#x-circle",
                    cssClass: "area_action",
                    padding: 2,
                    toolTip: "Delete",
                    onClick: async args => {
                        const e = args.source;
                        const modal = await DayPilot.Modal.confirm("Delete this absence request?");
                        if (modal.canceled) {
                            return true;
                        }
                        await DayPilot.Http.delete(`/api/absences/${e.id()}`);
                        scheduler.events.remove(e);
                        console.log("Deleted.");
                    }
                });
            }
        },
    });
    scheduler.init();

    const datepicker = new DayPilot.Navigator("datepicker", {
        selectMode: "Day",
        showMonths: 3,
        skipMonths: 3,
        onTimeRangeSelected: args => {
            scheduler.update({
                startDate: args.start,
            });
            app.loadSchedulerData();
        },
        onVisibleRangeChanged: args => {
            app.loadDatePickerData();
        }
    });
    datepicker.init();

    const app = {
        elements: {
            previous: document.getElementById("previous"),
            today: document.getElementById("today"),
            next: document.getElementById("next"),
            filterPending: document.getElementById("filterPending"),
            filterApproved: document.getElementById("filterApproved"),
            filterRejected: document.getElementById("filterRejected"),
            filterCancelled: document.getElementById("filterCancelled")
        },
        state: {
            selectedStatuses: ["Pending", "Approved", "Rejected", "Cancelled"],
            currentEmployeeId: null,
            isManager: false,
            currentUser: null,
            isMockMode: false
        },
        async init() {
            // Load current user information
            await this.loadCurrentUser();

            // Initialize checkboxes based on role
            this.initializeCheckboxes();

            this.loadSchedulerData();
            this.loadDatePickerData();
            this.initEventHandlers();
        },
        initializeCheckboxes() {
            // Determine which checkboxes should be available based on role
            const isAdmin = this.state.currentUser?.roles?.includes("Admin");
            const isManagerOrApprover = this.state.isManager;
            const isEmployee = !isAdmin && !isManagerOrApprover;

            // First, ensure all checkboxes are visible (reset state)
            this.elements.filterPending.parentElement.style.display = "flex";
            this.elements.filterApproved.parentElement.style.display = "flex";
            this.elements.filterRejected.parentElement.style.display = "flex";
            this.elements.filterCancelled.parentElement.style.display = "flex";

            // Hide/show checkboxes based on role
            if (isEmployee) {
                // Employees can see ALL approved absences, but only their own pending/rejected/cancelled
                this.elements.filterPending.checked = false;
                this.elements.filterApproved.checked = true;
                this.elements.filterRejected.checked = false;
                this.elements.filterCancelled.checked = false;
                this.state.selectedStatuses = ["Approved"];
            } else if (isManagerOrApprover && !isAdmin) {
                // Managers/Approvers mainly care about Pending (to approve) and Approved (to verify)
                this.elements.filterPending.checked = true;
                this.elements.filterApproved.checked = true;
                this.elements.filterRejected.checked = false;
                this.elements.filterCancelled.checked = false;
                // Hide rejected and cancelled for managers/approvers
                this.elements.filterRejected.parentElement.style.display = "none";
                this.elements.filterCancelled.parentElement.style.display = "none";
                this.state.selectedStatuses = ["Pending", "Approved"];
            } else if (isAdmin) {
                // Admins see everything by default
                this.elements.filterPending.checked = true;
                this.elements.filterApproved.checked = true;
                this.elements.filterRejected.checked = true;
                this.elements.filterCancelled.checked = true;
                this.state.selectedStatuses = ["Pending", "Approved", "Rejected", "Cancelled"];
                console.log("initializeCheckboxes - Admin mode, selectedStatuses:", this.state.selectedStatuses);
            }
        },
        async loadCurrentUser() {
            try {
                const response = await DayPilot.Http.get("/api/currentuser");
                if (response.data) {
                    this.state.currentUser = response.data;
                    this.state.currentEmployeeId = response.data.id;
                    this.state.isMockMode = response.data.isMockMode || false;
                    this.state.isManager = response.data.isApprover ||
                        response.data.roles?.some(r =>
                            r.toLowerCase() === 'manager' ||
                            r.toLowerCase() === 'approver'
                        );

                    console.log("Current user:", this.state.currentUser);
                    console.log("Is manager/approver:", this.state.isManager);
                    console.log("Mock mode:", this.state.isMockMode);
                }
            } catch (error) {
                console.warn("Could not load current user, using defaults:", error);
                // Fallback for development without authentication
                this.state.currentEmployeeId = 1;
            }
        },
        async loadSchedulerData() {
            const start = scheduler.visibleStart();
            const end = scheduler.visibleEnd();

            console.log("loadSchedulerData - selectedStatuses:", this.state.selectedStatuses);
            let absencesUrl = `/api/absences?start=${start}&end=${end}`;

            // Add all selected statuses to the query (using array notation for ASP.NET Core)
            this.state.selectedStatuses.forEach(status => {
                absencesUrl += `&status[]=${status}`;
            });
            console.log("loadSchedulerData - URL:", absencesUrl);

            // For employees: Show ALL approved absences, but only their own pending/rejected/cancelled
            const isEmployee = !this.state.isManager && !this.state.currentUser?.roles?.includes("Admin");
            if (isEmployee) {
                // Check if user is viewing ONLY approved absences
                const onlyApproved = this.state.selectedStatuses.length === 1 &&
                    this.state.selectedStatuses[0] === "Approved";

                // If viewing any non-approved status, filter to employee's own requests
                if (!onlyApproved) {
                    absencesUrl += `&employeeId=${this.state.currentEmployeeId}`;
                }
                // If viewing ONLY approved, don't add employeeId filter (show everyone's)
            }

            const promiseAbsences = DayPilot.Http.get(absencesUrl);
            const promiseResources = DayPilot.Http.get("/api/resources");

            const [{ data: resources }, { data: absences }] = await Promise.all([promiseResources, promiseAbsences]);

            console.log("loadSchedulerData - API returned", absences.length, "absences");
            console.log("loadSchedulerData - Absence statuses:", absences.map(a => a.status));

            // Map absences to scheduler events
            const events = absences.map(a => ({
                id: a.id,
                start: a.start,
                end: a.end,
                text: a.reason,
                resource: a.employeeId,
                barColor: getStatusColor(a.status),
                data: a
            }));

            console.log("loadSchedulerData - Updating scheduler with", events.length, "events");

            scheduler.update({
                resources,
                events
            });
        },
        async loadDatePickerData() {
            const start = datepicker.visibleStart();
            const end = datepicker.visibleEnd();

            let absencesUrl = `/api/absences?start=${start}&end=${end}`;

            // Add all selected statuses to the query (using array notation for ASP.NET Core)
            this.state.selectedStatuses.forEach(status => {
                absencesUrl += `&status[]=${status}`;
            });

            // For employees: Show ALL approved absences, but only their own pending/rejected/cancelled
            const isEmployee = !this.state.isManager && !this.state.currentUser?.roles?.includes("Admin");
            if (isEmployee) {
                // Check if user is viewing ONLY approved absences
                const onlyApproved = this.state.selectedStatuses.length === 1 &&
                    this.state.selectedStatuses[0] === "Approved";

                // If viewing any non-approved status, filter to employee's own requests
                if (!onlyApproved) {
                    absencesUrl += `&employeeId=${this.state.currentEmployeeId}`;
                }
                // If viewing ONLY approved, don't add employeeId filter (show everyone's)
            }

            const { data } = await DayPilot.Http.get(absencesUrl);

            const events = data.map(a => ({
                start: a.start,
                end: a.end,
                text: a.reason,
                barColor: getStatusColor(a.status)
            }));

            datepicker.update({ events });
        },
        addHandlers() {
            app.elements.previous.addEventListener("click", () => {
                const currentStart = scheduler.startDate;
                scheduler.update({
                    startDate: currentStart.addDays(-21)
                });
                app.loadSchedulerData();
            });
            app.elements.next.addEventListener("click", () => {
                const currentStart = scheduler.startDate;
                scheduler.update({
                    startDate: currentStart.addDays(21)
                });
                app.loadSchedulerData();
            });
            app.elements.today.addEventListener("click", () => {
                scheduler.update({
                    startDate: DayPilot.Date.today().addDays(-7)
                });
                app.loadSchedulerData();
            });

            // Checkbox filter handlers
            const updateFilters = () => {
                console.log("[updateFilters] Checkbox states:", {
                    pending: app.elements.filterPending.checked,
                    approved: app.elements.filterApproved.checked,
                    rejected: app.elements.filterRejected.checked,
                    cancelled: app.elements.filterCancelled.checked
                });
                app.state.selectedStatuses = [];
                if (app.elements.filterPending.checked) app.state.selectedStatuses.push("Pending");
                if (app.elements.filterApproved.checked) app.state.selectedStatuses.push("Approved");
                if (app.elements.filterRejected.checked) app.state.selectedStatuses.push("Rejected");
                if (app.elements.filterCancelled.checked) app.state.selectedStatuses.push("Cancelled");
                console.log("[updateFilters] selectedStatuses:", app.state.selectedStatuses);

                app.loadSchedulerData();
                app.loadDatePickerData();
            };

            app.elements.filterPending.addEventListener("change", updateFilters);
            app.elements.filterApproved.addEventListener("change", updateFilters);
            app.elements.filterRejected.addEventListener("change", updateFilters);
            app.elements.filterCancelled.addEventListener("change", updateFilters);
        },
        initEventHandlers() {
            this.addHandlers();
        }
    };

    // Helper function to check if user can create absence for a resource
    function canCreateAbsenceForResource(currentEmployeeId, targetResourceId, isManager, isAdmin, isApprover = false) {
        // Admins, Managers, and Approvers can create absences for anyone
        if (isAdmin || isManager || isApprover) {
            return true;
        }

        // Regular employees can only create absences for themselves
        return currentEmployeeId === targetResourceId;
    }

    app.init();

</script>