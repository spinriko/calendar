@if (ViewData["ShowImpersonation"] as bool? ?? false)
{
    <div class="impersonation-panel position-fixed bottom-0 end-0 m-3 p-3 bg-warning border border-dark shadow-lg"
        style="z-index: 9999; max-width: 300px;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>ðŸŽ­ Impersonation</strong>
            <button type="button" class="btn-close btn-close-white" onclick="toggleImpersonationPanel()"
                aria-label="Close"></button>
        </div>

        <div class="mb-2">
            <label for="impersonateUser" class="form-label small">Impersonate As:</label>
            <select id="impersonateUser" class="form-select form-select-sm">
                <option value="EMP001">Test Employee 1 - Employee</option>
                <option value="EMP002">Test Employee 2 - Employee</option>
                <option value="MGR001">Test Manager - Manager</option>
                <option value="APR001">Test Approver - Approver</option>
                <option value="ADMIN001">Administrator - Admin</option>
            </select>
        </div>
    </div>
}

<script type="module">
    (async () => {
        // Try to load the fingerprinted filename from the manifest, fall back to the unhashed path
        let moduleUrl = '/dist/impersonation-panel.js';
        try {
            const resp = await fetch('/dist/asset-manifest.json', { cache: 'no-store' });
            if (resp && resp.ok) {
                const manifest = await resp.json();
                if (manifest && manifest['impersonation-panel.js']) {
                    moduleUrl = manifest['impersonation-panel.js'];
                }
            }
        } catch (e) {
            // ignore manifest errors and fall back
        }

        try {
            const mod = await import(moduleUrl);
            const toggleImpersonationPanel = mod.toggleImpersonationPanel || mod.default?.toggleImpersonationPanel;
            const applyImpersonation = mod.applyImpersonation || mod.default?.applyImpersonation;
            const initImpersonationPanel = mod.initImpersonationPanel || mod.default?.initImpersonationPanel;

            // Make functions available globally for onclick handlers
            window.toggleImpersonationPanel = toggleImpersonationPanel;

            // Initialize the panel when DOM is ready
            const baseUrl = '@Url.Content("~/")';
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => initImpersonationPanel && initImpersonationPanel(baseUrl));
            } else {
                if (initImpersonationPanel) initImpersonationPanel(baseUrl);
            }

            // Apply impersonation immediately when dropdown changes
            document.getElementById('impersonateUser')?.addEventListener('change', () => applyImpersonation && applyImpersonation());
        } catch (err) {
            console.error('Failed to load impersonation-panel module', err);
        }
    })();
</script>