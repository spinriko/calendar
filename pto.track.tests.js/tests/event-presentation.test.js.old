QUnit.module('Event Presentation', function () {
    QUnit.test('buildContextMenuItems includes "View Details" for all statuses', function (assert) {
        const pendingAbsence = {
            id: '123',
            employeeName: 'Doe, John',
            reason: 'Vacation',
            status: 'Pending',
            requestedDate: '2025-11-01T00:00:00'
        };

        const approvedAbsence = {
            id: '456',
            employeeName: 'Smith, Jane',
            reason: 'Sick Leave',
            status: 'Approved',
            requestedDate: '2025-11-02T00:00:00',
            approverName: 'Manager, Bob',
            approvedDate: '2025-11-02T10:00:00'
        };

        const pendingItems = buildContextMenuItems(pendingAbsence, {});
        const approvedItems = buildContextMenuItems(approvedAbsence, {});

        assert.ok(pendingItems.some(item => item.text === 'View Details'), 'Pending absence has View Details');
        assert.ok(approvedItems.some(item => item.text === 'View Details'), 'Approved absence has View Details');
    });

    QUnit.test('buildContextMenuItems includes "Edit Reason" only for Pending status', function (assert) {
        const pendingAbsence = {
            id: '123',
            status: 'Pending',
            reason: 'Vacation',
            employeeName: 'Doe, John'
        };

        const approvedAbsence = {
            id: '456',
            status: 'Approved',
            reason: 'Sick Leave',
            employeeName: 'Smith, Jane'
        };

        const pendingItems = buildContextMenuItems(pendingAbsence, {});
        const approvedItems = buildContextMenuItems(approvedAbsence, {});

        assert.ok(pendingItems.some(item => item.text === 'Edit Reason'), 'Pending absence has Edit Reason');
        assert.notOk(approvedItems.some(item => item.text === 'Edit Reason'), 'Approved absence does not have Edit Reason');
    });

    QUnit.test('buildContextMenuItems includes "Approve" and "Reject" only for Pending status', function (assert) {
        const pendingAbsence = {
            id: '123',
            status: 'Pending',
            reason: 'Vacation',
            employeeName: 'Doe, John'
        };

        const approvedAbsence = {
            id: '456',
            status: 'Approved',
            reason: 'Sick Leave',
            employeeName: 'Smith, Jane'
        };

        const rejectedAbsence = {
            id: '789',
            status: 'Rejected',
            reason: 'Personal',
            employeeName: 'Brown, Alice'
        };

        const pendingItems = buildContextMenuItems(pendingAbsence, {});
        const approvedItems = buildContextMenuItems(approvedAbsence, {});
        const rejectedItems = buildContextMenuItems(rejectedAbsence, {});

        assert.ok(pendingItems.some(item => item.text === 'Approve'), 'Pending absence has Approve');
        assert.ok(pendingItems.some(item => item.text === 'Reject'), 'Pending absence has Reject');
        assert.notOk(approvedItems.some(item => item.text === 'Approve'), 'Approved absence does not have Approve');
        assert.notOk(approvedItems.some(item => item.text === 'Reject'), 'Approved absence does not have Reject');
        assert.notOk(rejectedItems.some(item => item.text === 'Approve'), 'Rejected absence does not have Approve');
        assert.notOk(rejectedItems.some(item => item.text === 'Reject'), 'Rejected absence does not have Reject');
    });

    QUnit.test('buildContextMenuItems includes "Delete" for Pending and Cancelled statuses', function (assert) {
        const pendingAbsence = {
            id: '123',
            status: 'Pending',
            reason: 'Vacation',
            employeeName: 'Doe, John'
        };

        const cancelledAbsence = {
            id: '456',
            status: 'Cancelled',
            reason: 'Personal',
            employeeName: 'Smith, Jane'
        };

        const approvedAbsence = {
            id: '789',
            status: 'Approved',
            reason: 'Sick Leave',
            employeeName: 'Brown, Alice'
        };

        const rejectedAbsence = {
            id: '999',
            status: 'Rejected',
            reason: 'Conference',
            employeeName: 'White, Bob'
        };

        const pendingItems = buildContextMenuItems(pendingAbsence, {});
        const cancelledItems = buildContextMenuItems(cancelledAbsence, {});
        const approvedItems = buildContextMenuItems(approvedAbsence, {});
        const rejectedItems = buildContextMenuItems(rejectedAbsence, {});

        assert.ok(pendingItems.some(item => item.text === 'Delete'), 'Pending absence has Delete');
        assert.ok(cancelledItems.some(item => item.text === 'Delete'), 'Cancelled absence has Delete');
        assert.notOk(approvedItems.some(item => item.text === 'Delete'), 'Approved absence does not have Delete');
        assert.notOk(rejectedItems.some(item => item.text === 'Delete'), 'Rejected absence does not have Delete');
    });

    QUnit.test('buildContextMenuItems includes separators for Pending status', function (assert) {
        const pendingAbsence = {
            id: '123',
            status: 'Pending',
            reason: 'Vacation',
            employeeName: 'Doe, John'
        };

        const items = buildContextMenuItems(pendingAbsence, {});
        const separators = items.filter(item => item.text === '-');

        assert.ok(separators.length >= 2, 'Pending absence has at least 2 separators');
    });

    QUnit.test('buildContextMenuItems does not include separators for non-Pending statuses', function (assert) {
        const approvedAbsence = {
            id: '456',
            status: 'Approved',
            reason: 'Sick Leave',
            employeeName: 'Smith, Jane'
        };

        const items = buildContextMenuItems(approvedAbsence, {});
        const separators = items.filter(item => item.text === '-');

        assert.equal(separators.length, 0, 'Approved absence has no separators');
    });

    QUnit.test('Event text uses employeeName when available', function (assert) {
        const absence = {
            id: '123',
            employeeName: 'Doe, John',
            reason: 'Vacation',
            status: 'Approved'
        };

        const eventText = absence.employeeName || absence.reason;

        assert.equal(eventText, 'Doe, John', 'Event text uses employeeName');
    });

    QUnit.test('Event text falls back to reason when employeeName is not available', function (assert) {
        const absence = {
            id: '123',
            reason: 'Vacation',
            status: 'Approved'
        };

        const eventText = absence.employeeName || absence.reason;

        assert.equal(eventText, 'Vacation', 'Event text falls back to reason');
    });

    QUnit.test('buildContextMenuItems onclick handlers are functions', function (assert) {
        const pendingAbsence = {
            id: '123',
            status: 'Pending',
            reason: 'Vacation',
            employeeName: 'Doe, John',
            requestedDate: '2025-11-01T00:00:00'
        };

        const items = buildContextMenuItems(pendingAbsence, {});
        const actionItems = items.filter(item => item.text !== '-');

        actionItems.forEach(item => {
            assert.ok(typeof item.onClick === 'function', `${item.text} has onClick function`);
        });
    });

    QUnit.test('buildContextMenuItems includes approval comments in View Details when present', function (assert) {
        const absenceWithComments = {
            id: '123',
            employeeName: 'Doe, John',
            reason: 'Vacation',
            status: 'Approved',
            requestedDate: '2025-11-01T00:00:00',
            approverName: 'Manager, Bob',
            approvedDate: '2025-11-02T00:00:00',
            approvalComments: 'Approved for Q4'
        };

        // This test verifies the function accepts absence with comments
        // The actual form building logic would be tested through integration tests
        const items = buildContextMenuItems(absenceWithComments, {});

        assert.ok(items.some(item => item.text === 'View Details'), 'Absence with comments has View Details');
    });
});
